---
export const prerender = false;

import Layout from '../../layouts/BaseLayout.astro';

import { fetchPostBySlug, fetchRelatedPosts, fetchAuthorById } from '../../lib/directus/fetchers';
import { getDirectusAssetURL } from '../../lib/directus/directus-utils';
import Container from '@/components/ui/Container';
import DirectusImage from '@/components/shared/DirectusImage';
import Headline from '@/components/ui/Headline';
import ShareDialog from '@/components/ui/ShareDialog';
import { Separator } from '@/components/ui/separator';
import Text from '@/components/ui/Text';
import type { DirectusFile, ExtensionSeoMetadata } from '@/types/directus-schema';

const { slug } = Astro.params;

let post;
try {
  post = await fetchPostBySlug(slug as string);
} catch (error) {
  console.error('Error loading post:', error);
  post = null;
}

if (!post) {
  return Astro.redirect('/404');
}

const relatedPosts = await fetchRelatedPosts(post.id);
const author = post.author ? await fetchAuthorById(post.author as string) : null;
const authorName = [author?.first_name, author?.last_name].filter(Boolean).join(' ');
const siteURL = import.meta.env.PUBLIC_SITE_URL || '';
const postUrl = `${siteURL}/blog/${slug}`;
const ogImage = post.image ? getDirectusAssetURL(post.image) : null;

const metadata = {
  title: post?.seo?.title ?? post.title ?? '',
  description: post?.seo?.meta_description ?? '',
  openGraph: {
    title: post?.seo?.title ?? post.title ?? '',
    description: post?.seo?.meta_description ?? '',
    url: postUrl,
    type: 'article',
    images: ogImage ? [{ url: ogImage }] : undefined,
  },
};
---
<Layout metadata={metadata}>
  <Container className="py-12">
    {post.image && (
      <div class="mb-8">
        <div class="relative w-full h-[400px] overflow-hidden rounded-lg">
          <DirectusImage
            uuid={post.image as string}
            alt={post.title || 'post header image'}
            className="object-cover"
            fill
            sizes="(max-width: 768px) 100vw, (max-width: 1200px) 100vw, 1200px"
          />
        </div>
      </div>
    )}

    <Headline as="h2" headline={post.title} className="!text-accent mb-4" />
    <Separator className="mb-8" />

    <div class="grid grid-cols-1 lg:grid-cols-[minmax(0,_2fr)_400px] gap-12">
      <main class="text-left">
        <Text content={post.content || ''} />
      </main>

      <aside class="space-y-6 p-6 rounded-lg max-w-[496px] h-fit bg-background-muted">
        {author && (
          <div class="flex items-center space-x-4">
            {author.avatar && (
              <DirectusImage
                uuid={author.avatar as string}
                alt={authorName || 'author avatar'}
                className="rounded-full object-cover"
                width={48}
                height={48}
              />
            )}
            {authorName && <p class="font-bold">{authorName}</p>}
          </div>
        )}

        {post.description && <p>{post.description}</p>}

        <div class="flex justify-start">
          <ShareDialog client:load postUrl={postUrl} postTitle={post.title} />
        </div>

        <div>
          <Separator className="my-4" />
          <h3 class="font-bold mb-4">Related Posts</h3>
          <div class="space-y-4">
            {relatedPosts.map((relatedPost: { slug: string | null | undefined; id: string; image: string | DirectusFile | null | undefined; title: string; seo: ExtensionSeoMetadata | null | undefined; }) => (
              <a
                href={`/blog/${relatedPost.slug}`}
                class="flex items-center space-x-4 hover:text-accent group"
              >
                {relatedPost.image && (
                  <div class="relative shrink-0 w-[150px] h-[100px] overflow-hidden rounded-lg">
                    <DirectusImage
                      uuid={relatedPost.image as string}
                      alt={relatedPost.title || 'related posts'}
                      className="object-cover transition-transform duration-300 group-hover:scale-110"
                      fill
                      sizes="(max-width: 768px) 100px, (max-width: 1024px) 150px, 150px"
                    />
                  </div>
                )}
                <span class="font-heading">{relatedPost.title}</span>
              </a>
            ))}
          </div>
        </div>
      </aside>
    </div>
  </Container>
</Layout>
